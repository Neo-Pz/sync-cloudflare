<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>设置广场房间</title>
  <style>
    body {
      font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    h1 {
      color: #3b82f6;
      text-align: center;
    }
    .container {
      background-color: #f9fafb;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    .button {
      background-color: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      display: block;
      margin: 20px auto;
      transition: background-color 0.3s;
    }
    .button:hover {
      background-color: #2563eb;
    }
    #output {
      background-color: #f0f0f0;
      border-radius: 4px;
      padding: 15px;
      margin-top: 20px;
      white-space: pre-wrap;
      font-family: monospace;
      max-height: 300px;
      overflow-y: auto;
    }
    .steps {
      margin-top: 20px;
      background-color: #e0f2fe;
      padding: 15px;
      border-radius: 4px;
    }
    .note {
      color: #dc2626;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>设置广场房间工具</h1>
    <p>此工具用于将已发布的房间设置为广场房间，以便在广场标签页中显示。</p>
    
    <div class="steps">
      <h3>使用步骤：</h3>
      <ol>
        <li>确保你已登录到 tldraw 应用</li>
        <li>点击下方的"设置广场房间"按钮</li>
        <li>查看操作日志</li>
        <li>刷新 tldraw 应用页面，查看广场标签页</li>
      </ol>
    </div>
    
    <p class="note">注意：此工具会修改本地存储的房间数据，并尝试更新云端数据。</p>
    
    <button id="runScript" class="button">设置广场房间</button>
    
    <div id="output">等待操作...</div>
  </div>

  <script>
    // 原始 console.log 方法
    const originalConsoleLog = console.log;
    const originalConsoleError = console.error;
    
    // 重定向 console.log 和 console.error 到页面
    console.log = function() {
      const args = Array.from(arguments);
      const message = args.map(arg => 
        typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
      ).join(' ');
      
      const output = document.getElementById('output');
      output.innerHTML += message + '\n';
      output.scrollTop = output.scrollHeight;
      
      // 同时输出到原始 console
      originalConsoleLog.apply(console, arguments);
    };
    
    console.error = function() {
      const args = Array.from(arguments);
      const message = args.map(arg => 
        typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
      ).join(' ');
      
      const output = document.getElementById('output');
      output.innerHTML += '<span style="color: red;">' + message + '</span>\n';
      output.scrollTop = output.scrollHeight;
      
      // 同时输出到原始 console
      originalConsoleError.apply(console, arguments);
    };

    // 设置广场房间脚本
    async function setPlazaRooms() {
      console.log('开始设置广场房间...');
      
      try {
        // 从 localStorage 获取房间列表
        const savedRooms = localStorage.getItem('tldraw-rooms');
        if (!savedRooms) {
          console.error('没有找到房间数据');
          return;
        }
        
        let rooms = JSON.parse(savedRooms);
        console.log(`找到 ${rooms.length} 个房间`);
        
        // 获取已发布的房间
        const publishedRooms = rooms.filter(room => room.published === true);
        console.log(`其中 ${publishedRooms.length} 个房间已发布`);
        
        if (publishedRooms.length === 0) {
          console.log('没有已发布的房间可以设置为广场房间');
          
          // 如果没有已发布的房间，将第一个房间设置为已发布并标记为广场房间
          if (rooms.length > 0) {
            console.log('将第一个房间设置为已发布并标记为广场房间');
            rooms[0].published = true;
            rooms[0].plaza = true;
            rooms[0].publishStatus = 'published';
            rooms[0].lastModified = Date.now();
            
            localStorage.setItem('tldraw-rooms', JSON.stringify(rooms));
            console.log('设置成功');
          }
          
          return;
        }
        
        // 将已发布房间的前两个设置为广场房间
        const plazaCount = Math.min(publishedRooms.length, 2);
        let plazaSet = 0;
        
        rooms = rooms.map(room => {
          if (room.published && plazaSet < plazaCount) {
            room.plaza = true;
            room.lastModified = Date.now();
            plazaSet++;
            console.log(`将房间 "${room.name}" (${room.id}) 设置为广场房间`);
          }
          return room;
        });
        
        // 保存更新后的房间列表
        localStorage.setItem('tldraw-rooms', JSON.stringify(rooms));
        console.log(`成功设置 ${plazaSet} 个广场房间`);
        
        // 尝试调用云端 API 更新房间
        console.log('尝试更新云端数据...');
        const plazaRooms = rooms.filter(room => room.plaza === true);
        
        for (const room of plazaRooms) {
          try {
            const response = await fetch(`/api/rooms/${room.id}/plaza`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ plaza: true })
            });
            
            if (response.ok) {
              console.log(`成功更新云端房间 "${room.name}" (${room.id})`);
            } else {
              console.error(`更新云端房间 "${room.name}" (${room.id}) 失败:`, await response.text());
            }
          } catch (error) {
            console.error(`更新云端房间 "${room.name}" (${room.id}) 时出错:`, error);
          }
        }
        
        console.log('广场房间设置完成');
        console.log('请刷新 tldraw 应用页面，查看广场标签页');
        
      } catch (error) {
        console.error('设置广场房间时出错:', error);
      }
    }

    // 绑定按钮点击事件
    document.getElementById('runScript').addEventListener('click', function() {
      document.getElementById('output').innerHTML = ''; // 清空输出
      setPlazaRooms().catch(console.error);
    });
  </script>
</body>
</html> 